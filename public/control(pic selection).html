<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Control Panel</title>
  <style>
    button {
      background-color: #007bff; /* Blue */
      color: white;
      border: none;
      padding: 8px 16px;
      margin: 5px 0;
      cursor: pointer;
      border-radius: 4px;
      font-size: 16px;
    }
    button:hover {
      background-color: #0056b3;
    }
    label {
      display: block;
      margin-top: 10px;
    }
    select, input {
      margin-bottom: 10px;
      padding: 5px;
      width: 100%;
      max-width: 300px;
    }
  </style>
</head>
<body>
  <h1>Auction Control</h1>

  <!-- Start Bidding Section -->
  <label>Player:</label>
  <select id="playerSelect" required>
    <option value="">Select Player</option>
  </select>

  <label>Photo (JPG/PNG):</label>
  <input type="file" id="photoInput" accept="image/*">

  <button id="startButton">Start Bidding</button>

  <!-- Increment Button -->
  <button id="incrementButton">Increment +50</button>

  <!-- Sold Section -->
  <label>Team (for Sold):</label>
  <select id="teamSelect" required>
    <option value="">Select Team</option>
    <option value="The Blue Bloods">The Blue Bloods</option>
    <option value="BB Young Bloods">BB Young Bloods</option>
    <option value="Power Strikers">Power Strikers</option>
    <option value="BB Lions">BB Lions</option>
    <option value="Duronto Express">Duronto Express</option>
  </select>
  <button id="soldButton">Sold!</button>

  <!-- Reset Auction Section -->
  <button id="resetButton">Reset Auction</button>

  <div id="error" style="color: red;"></div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const playerSelect = document.getElementById('playerSelect');
    const socket = io();

    // Initial load of players with original numbering
    let originalPlayers = [];
    function loadPlayers() {
      Promise.all([
        fetch('/players').then(res => res.json()),
        fetch('/sold-players').then(res => res.json())
      ])
        .then(([players, soldPlayers]) => {
          originalPlayers = players.map((p, i) => ({ ...p, originalIndex: i + 1 })); // Store original index
          updateDropdown(soldPlayers);
        })
        .catch(error => {
          document.getElementById('error').textContent = `Failed to load players: ${error.message}`;
          // Fallback: Load all players if sold-players fetch fails
          fetch('/players').then(res => res.json()).then(players => {
            originalPlayers = players.map((p, i) => ({ ...p, originalIndex: i + 1 }));
            updateDropdown([]);
          });
        });
    }

    // Update dropdown based on sold players
    function updateDropdown(soldPlayers) {
      const soldSet = new Set(soldPlayers);
      playerSelect.innerHTML = '<option value="">Select Player</option>';
      originalPlayers.forEach(player => {
        if (!soldSet.has(player.name)) {
          const option = document.createElement('option');
          option.value = player.name;
          option.textContent = `${player.originalIndex}. ${player.name} (${player.role}, Base: ${player.basePrice})`;
          playerSelect.appendChild(option);
        }
      });
    }

    // Refresh players on update event with error handling
    socket.on('update', () => {
      fetch('/sold-players', {
        headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' }
      })
        .then(res => {
          if (!res.ok) throw new Error(`HTTP error! Status: ${res.status}`);
          return res.json();
        })
        .then(soldPlayers => updateDropdown(soldPlayers))
        .catch(error => {
          console.error('Failed to fetch sold players:', error);
          document.getElementById('error').textContent = `Failed to update players: ${error.message}`;
          // Fallback: Reload all players if sold-players fails
          fetch('/players').then(res => res.json()).then(players => {
            originalPlayers = players.map((p, i) => ({ ...p, originalIndex: i + 1 }));
            updateDropdown([]);
          });
        });
    });

    // Initial load
    loadPlayers();

    // Handle Start Bidding
    document.getElementById('startButton').addEventListener('click', () => {
      const name = playerSelect.value;
      if (!name) {
        document.getElementById('error').textContent = 'Please select a player!';
        return;
      }
      const photoInput = document.getElementById('photoInput');
      const formData = new FormData();
      formData.append('name', name);
      if (photoInput.files[0]) formData.append('photo', photoInput.files[0]);

      fetch('/start', {
        method: 'POST',
        body: formData
      })
      .then(response => {
        if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
        return response.json();
      })
      .then(data => {
        if (data.error) {
          document.getElementById('error').textContent = data.error;
        } else {
          document.getElementById('error').textContent = '';
        }
      })
      .catch(error => {
        document.getElementById('error').textContent = `Failed to start bidding: ${error.message}`;
      });
    });

    // Handle Increment
    document.getElementById('incrementButton').addEventListener('click', () => {
      fetch('/increment', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ amount: 50 })
      })
      .then(response => {
        if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
        return response.json();
      })
      .then(data => {
        if (data.error) {
          document.getElementById('error').textContent = data.error;
        } else {
          document.getElementById('error').textContent = '';
        }
      })
      .catch(error => {
        document.getElementById('error').textContent = `Failed to increment: ${error.message}`;
      });
    });

    // Handle Sold
    document.getElementById('soldButton').addEventListener('click', () => {
      const team = document.getElementById('teamSelect').value;
      if (!team) {
        document.getElementById('error').textContent = 'Please select a team!';
        return;
      }
      fetch('/sold', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ team })
      })
      .then(response => {
        if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
        return response.json();
      })
      .then(data => {
        if (data.error) {
          document.getElementById('error').textContent = data.error;
        } else {
          document.getElementById('error').textContent = '';
        }
      })
      .catch(error => {
        document.getElementById('error').textContent = `Failed to sell: ${error.message}`;
      });
    });

    // Handle Reset Auction
    document.getElementById('resetButton').addEventListener('click', () => {
      fetch('/reset', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({})
      })
      .then(response => {
        if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
        return response.json();
      })
      .then(data => {
        if (data.error) {
          document.getElementById('error').textContent = data.error;
        } else {
          document.getElementById('error').textContent = 'Auction reset successfully!';
          loadPlayers(); // Reload all players after reset
        }
      })
      .catch(error => {
        document.getElementById('error').textContent = `Failed to reset: ${error.message}`;
      });
    });
  </script>
</body>
</html>