<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <img src="/uploads/logos/bbeft.jpg" 
     alt="Tournament Logo" 
     style="position: absolute; top: 15px; left: 250px; width: 100px; height: auto;">
  <title>BB Employees Football Tournament-2025 Player Auction</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="/socket.io/socket.io.js"></script>
  <style>
    body {
      background: linear-gradient(135deg, #612528 0%, #612528 100%);
      min-height: 100vh;
      margin: 0;
      padding: 0;
    }

    #logo {
      max-width: 100px;
      margin: 10px auto;
      display: block;
    }

    #playerInfo {
      background-color: white;
      padding: 1rem;
      border-radius: 0.5rem;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      width: 22rem;
      margin: .3rem auto;
      transition: opacity 0.3s ease-in-out;
      display: flex;
      flex-direction: column;
      align-items: center;
      text-align: center;
    }

    #playerInfo.loading { opacity: 0.5; }

    #photo {
      width: 20rem;
      height: 20rem;
      border-radius: 0.5rem;
      display: block;
      margin: 0 auto;
    }

    #name { font-weight: 700; font-size: 1.5rem; margin-top: 1rem; color: #1e40af; text-transform: uppercase; }
    #role, #basePrice { font-size: 1.125rem; font-weight:700; margin-top: 0.25rem; color: #4b5563; }
    #currentPrice { font-size: 1.5rem; font-weight: 1000; margin-top: 0.25rem; color: #42ab2b; }

    #sold-message, #unsold-message { font-size: 1.5rem; font-weight: 700; margin-top: 1rem; display: none; text-transform: uppercase; transition: all 0.3s ease; }
    #unsold-message { color: #f97316; }

    @keyframes spectacularSale {
      0% { transform: scale(0.9); opacity:0.8; color:#ffd700; }
      20% { transform: scale(1.1); opacity:1; color:#22c55e; }
      40% { transform: scale(1.05) translateX(-5px); color:#3b82f6; }
      60% { transform: scale(1.05) translateX(5px); color:#ffd700; }
      80% { transform: scale(1); color:#22c55e; }
      100% { transform: scale(1); opacity:0.8; color:#3b82f6; }
    }

    .spectacular { animation: spectacularSale 2s infinite ease-in-out; }

    @keyframes smoothBlink { 0%{opacity:1;}50%{opacity:0.3;}100%{opacity:1;} }
    .smooth-blink { animation: smoothBlink 0.7s infinite ease-in-out; }

    @keyframes timerBlink { 0%{opacity:1;}50%{opacity:0.3;}100%{opacity:1;} }
    .timer-blink { animation: timerBlink 0.4s infinite; }

    #timer { font-size:1.375rem; font-weight:700; color:#dc2626; margin-top:1rem; }

    #auctionContainer {
      display: grid;
      grid-template-areas:
        "left player right"
        "bottom bottom bottom";
      grid-template-columns: 1fr auto 1fr;
      grid-template-rows: auto auto;
      gap: .3rem;
      justify-items: center;
      align-items: start;
      margin-top: 1rem;
      position: relative;
    }

    #playerInfo { grid-area: player; }

    #leftRosters, #rightRosters {
      display: flex;
      flex-direction: column;
      gap: 1.5rem;
      position: relative;
      top: 100%;
      transform: translateY(-75%);
    }

    #bottomRoster {
      grid-area: bottom;
      display: flex;
      justify-content: center;
      gap: 0.5rem;
      margin-top: .3rem;
    }

    .team-box {
      background-color:white; border-radius:0.5rem; padding:1rem;
      width:18rem; box-shadow:0 2px 4px rgba(0,0,0,0.1);
      text-align:center; display:flex; flex-direction:column;
      align-items:center; justify-content:flex-start; min-height:10rem;
    }
    #bottomRoster .team-box { width: 22rem; }
    .team-box img { width:70px; height:70px; object-fit:contain; margin-bottom:0.5rem; }
    .team-box h3 { margin:0.5rem 0 0; font-size:1.25rem; color:#1d4ed8; text-transform:uppercase; font-weight:700; }
    .team-box p { margin:0.25rem 0; font-size:1rem; font-weight:700; }
    .highlight { border:2px solid #f59e0b; box-shadow:0 0 8px #f59e0b; }

    #chartView { display:none; opacity:0; transition:opacity 0.5s ease; }
    #chartView.show { opacity:1; }

    @media (max-width:640px) {
      #playerInfo { max-width:100%; padding:1rem; }
      #leftRosters, #rightRosters, #bottomRoster { top:0; transform:none; flex-direction:row; flex-wrap:wrap; justify-content:center; }
      .team-box { width:100%; }
      .team-box img { width:50px; height:50px; }
      .team-box h3 { font-size:1rem; }
    }
  </style>
</head>
<body>
  <div class="text-4xl font-bold text-white mt-4 text-center">
    <span>BB Employees Football Tournament-2025</span><br>
    <span>Player Auction</span>
  </div>

  <div id="auctionContainer">
    <div id="leftRosters"></div>

    <div id="playerInfo" class="loading">
      <img id="photo" src="" alt="Player Photo">
      <p id="name"></p>
      <p id="role"></p>
      <p id="basePrice"></p>
      <p id="currentPrice"></p>
      <div id="sold-message" class="hidden"></div>
      <div id="unsold-message" class="hidden">UNSOLDðŸ¥¹</div>
      <div id="timer">Time Left: 30s</div>
    </div>

    <div id="rightRosters"></div>
    <div id="bottomRoster"></div>
  </div>

  <div id="chartView"></div>

  <audio id="beepSound" src="/sounds/beep.mp3" preload="auto" muted></audio>
  <audio id="soldSound" src="/sounds/sold.mp3" preload="auto" muted></audio>
  <button id="enableSound" class="bg-sky-400 text-black px-4 py-2 rounded mt-4">Enable Sound</button>

  <script>
    let countdown = 30;
    const timerEl = document.getElementById('timer');
    const soldEl = document.getElementById('sold-message');
    const unsoldEl = document.getElementById('unsold-message');
    const beepSound = document.getElementById('beepSound');
    const soldSound = document.getElementById('soldSound');
    const enableSoundBtn = document.getElementById('enableSound');
    const auctionView = document.getElementById('auctionContainer');
    const chartView = document.getElementById('chartView');

    const leftRosters = document.getElementById('leftRosters');
    const rightRosters = document.getElementById('rightRosters');
    const bottomRoster = document.getElementById('bottomRoster');

    let countdownInterval, lastPrice = 0;
    let isSoundEnabled = false, isSoldDisplayed = false, isUnsoldDisplayed = false;

    beepSound.volume = 1.0; soldSound.volume = 1.0;
    beepSound.load(); soldSound.load();

    enableSoundBtn.addEventListener('click', () => {
      beepSound.muted = false; soldSound.muted = false;
      isSoundEnabled = true; enableSoundBtn.style.display = 'none';
      beepSound.play().then(() => beepSound.pause()).catch(()=>{});
    });

    function startCountdown(){
      countdown = 30;
      timerEl.innerText = `Time Left: ${countdown}s`;
      clearInterval(countdownInterval);
      countdownInterval = setInterval(() => {
        countdown--;
        if(countdown<=0){
          clearInterval(countdownInterval);
          timerEl.innerText=`Time Left: 0s`;
          timerEl.classList.remove('timer-blink');
          if(isSoundEnabled){ beepSound.pause(); beepSound.currentTime=0; }
        } else {
          timerEl.innerText=`Time Left: ${countdown}s`;
          if(countdown<=5 && isSoundEnabled){
            timerEl.classList.add('timer-blink');
            if(beepSound.paused) beepSound.play().catch(()=>{});
          } else {
            timerEl.classList.remove('timer-blink');
            if(isSoundEnabled){ beepSound.pause(); beepSound.currentTime=0; }
          }
        }
      },1000);
    }

    function showUnsoldMessage(){
      unsoldEl.style.display='block';
      if(!isUnsoldDisplayed){
        unsoldEl.classList.remove('smooth-blink');
        void unsoldEl.offsetWidth;
        unsoldEl.classList.add('smooth-blink');
        isUnsoldDisplayed=true;
      }
    }

    if(typeof io==='undefined'){
      console.error('Socket.io not loaded');
    } else {
      const socket = io();
      socket.on('connect', ()=>console.log('Connected to Socket.io server'));

      socket.on('update', (state) => {
        auctionView.style.display = "grid";
        chartView.style.display = "none";
        chartView.classList.remove('show');

        const playerInfo = document.getElementById('playerInfo');
        playerInfo.classList.add('loading');

        document.getElementById('photo').src = state.photo || 'https://via.placeholder.com/200';
        document.getElementById('name').innerText = state.name ? state.name.toUpperCase() : '';
        document.getElementById('role').innerText = state.role ? `Role: ${state.role}` : '';
        document.getElementById('basePrice').innerText = state.basePrice ? `Base Price: ${state.basePrice}` : '';

        // âœ… FIX: reset timer when undoing a sold/unsold player
        if(!state.isSold && !state.isUnsold && state.isBidding){
          clearInterval(countdownInterval);
          startCountdown();
        }

        if(state.isSold){
          document.getElementById('currentPrice').innerText='';
          timerEl.innerText='';
          soldEl.innerText=`Sold to ${state.soldTeam.toUpperCase()} for ${state.finalPrice}!`;
          if(!isSoldDisplayed){
            soldEl.style.display='block';
            soldEl.classList.remove('spectacular');
            void soldEl.offsetWidth;
            soldEl.classList.add('spectacular');
            if(isSoundEnabled) soldSound.play().catch(()=>{});
            isSoldDisplayed=true;
          }
          unsoldEl.style.display='none'; isUnsoldDisplayed=false;
          clearInterval(countdownInterval);
        } else if(state.isUnsold){
          document.getElementById('currentPrice').innerText='';
          timerEl.innerText='';
          showUnsoldMessage();
          clearInterval(countdownInterval);
        } else if(state.isBidding){
          document.getElementById('currentPrice').innerText=`Current Price: ${state.currentPrice}`;
          if(!countdownInterval || state.currentPrice!==lastPrice){ startCountdown(); lastPrice=state.currentPrice; }
          unsoldEl.style.display='none'; isUnsoldDisplayed=false;
          soldEl.style.display='none'; isSoldDisplayed=false;
        } else {
          document.getElementById('currentPrice').innerText='';
          timerEl.innerText='';
          unsoldEl.style.display='none'; isUnsoldDisplayed=false;
          soldEl.style.display='none'; isSoldDisplayed=false;
          clearInterval(countdownInterval);
        }

        leftRosters.innerHTML = '';
        rightRosters.innerHTML = '';
        bottomRoster.innerHTML = '';

        const teams = Object.entries(state.teamRosters);
        teams.forEach(([team, players], index) => {
          const budget = state.teamBudgets[team] || 0;
          const originalTeam = Object.keys(state.teamLogos).find(t=>t.toLowerCase()===team.toLowerCase());
          const logo = state.teamLogos[originalTeam] || 'https://via.placeholder.com/70';
          const box = document.createElement('div');
          box.className = 'team-box';
          if(state.soldTeam && team.toLowerCase() === state.soldTeam.toLowerCase()) box.classList.add('highlight');

          const nextPlayerNumber = players.length + 1; 
          let maxCredit = budget - (11 - nextPlayerNumber) * 200;
          if(maxCredit < 0) maxCredit = 0;

          box.innerHTML = `
            <img src="${logo}" alt="${originalTeam} Logo">
            <h3>${originalTeam||team}</h3>
            <p>Remaining Balance: ${budget}</p>
            <p>Max Credit to Bid: ${maxCredit}</p>
            <p>Purchased Player: ${players.length}</p>
          `;

          if(index === 0 || index === 1) leftRosters.appendChild(box);
          else if(index === 2 || index === 3) rightRosters.appendChild(box);
          else bottomRoster.appendChild(box);
        });

        playerInfo.classList.remove('loading');
      });

      socket.on('displayPlayerChart',({team,logo,purchased})=>{
        auctionView.style.display='none';
        chartView.style.display='block';
        chartView.classList.add('show');
        chartView.innerHTML=`
          <div class="text-center p-4 text-blue-900 bg-white min-h-screen">
            <img src="${logo}" alt="${team} Logo" class="mx-auto" style="max-width:120px;">
            <h1 class="text-2xl font-bold mt-4">${team}</h1>
            <h2 class="underline text-xl mt-2">Purchased Player List</h2>
            <div class="mt-4 text-lg text-left max-w-xl mx-auto">
              ${purchased && purchased.length>0 ? purchased.map(p=>`<p>${p.serial}. ${p.name} (${p.role}) >>> ${p.price}</p>`).join('') : `<p>No players purchased yet.</p>`}
            </div>
          </div>
        `;
      });
    }
  </script>
</body>
</html>